openapi: 3.0.3
info:
  title: API Plataforma de Voluntariado
  description: API Backend para la gestión de voluntarios, organizaciones y actividades solidarias.
  version: 1.0.0
servers:
  - url: http://localhost:8000/api
    description: Servidor Local Symfony

paths:
  # ==========================================
  # AUTENTICACIÓN Y REGISTRO
  # ==========================================
  /auth/login:
    post:
      tags:
        - Autenticación
      summary: Iniciar sesión
      description: Login común para Voluntarios y Organizaciones.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login exitoso. Devuelve token y rol.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciales incorrectas

  /auth/register/voluntario:
    post:
      tags:
        - Autenticación
      summary: Registrar nuevo voluntario
      description: Crea un voluntario con perfil completo (habilidades, disponibilidad, etc.)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoluntarioRegistro'
      responses:
        '201':
          description: Voluntario creado correctamente
        '409':
          description: El DNI o Correo ya existen

  /auth/register/organizacion:
    post:
      tags:
        - Autenticación
      summary: Registrar nueva organización
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizacionRegistro'
      responses:
        '201':
          description: Organización creada correctamente
        '409':
          description: El CIF o Email ya existen

  /organizations:
    get:
      tags:
        - Organizaciones
      summary: Listar todas las organizaciones
      description: Devuelve la lista completa de organizaciones registradas.
      responses:
        '200':
          description: Lista recuperada con éxito
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrganizacionDetalle'
    post:
      tags:
        - Organizaciones
      summary: Registrar nueva organización
      description: Crea una nueva organización en la plataforma.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizacionRegistro'
      responses:
        '201':
          description: Organización creada correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizacionDetalle'
        '400':
          description: Datos inválidos
        '409':
          description: El CIF o Email ya existen

  /organizations/{cif}/state:
    patch:
      tags:
        - Organizaciones
      summary: Actualizar estado de una organización
      description: Permite cambiar el estado (pendiente, aprobado, rechazado) de una organización.
      parameters:
        - name: cif
          in: path
          required: true
          description: CIF de la organización
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [estado]
              properties:
                estado:
                  type: string
                  enum: [pendiente, aprobado, rechazado]
                  example: "aprobado"
      responses:
        '200':
          description: Estado actualizado correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizacionDetalle'
        '400':
          description: Estado inválido
        '404':
          description: Organización no encontrada

  /voluntarios/email/{email}:
    get:
      summary: Obtiene los datos de un voluntario por su email.
      tags:
        - Voluntarios
      parameters:
        - in: path
          name: email
          schema:
            type: string
          required: true
          description: Correo electrónico del voluntario
      responses:
        '200':
          description: Datos del voluntario.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoluntarioDetalle'
        '404':
          description: Voluntario no encontrado.

  /organizations/by-email:
    post:
      summary: Obtiene una organización por su email.
      tags:
        - Organizaciones
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                  example: "organizacion@email.com"
      responses:
        '200':
          description: Datos de la organización.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizacionDetalle'
        '400':
          description: Email requerido.
        '404':
          description: Organización no encontrada.

  # ==========================================
  # ACTIVIDADES
  # ==========================================
  /actividades/organizacion/{cif}:
    get:
      summary: Obtiene las actividades de una organización con sus inscripciones (opcionalmente filtradas).
      tags:
        - Actividades
      parameters:
        - in: path
          name: cif
          schema:
            type: string
          required: true
          description: CIF de la organización
        - in: query
          name: estado
          schema:
            type: string
            enum: [PENDIENTE, EN_CURSO, FINALIZADO, CANCELADO, Pendiente, En Curso, Finalizado, Cancelado]
          required: false
          description: Filtra las actividades por su fase de ejecución (ej. 'En Curso').
        - in: query
          name: estadoAprobacion
          schema:
            type: string
            enum: [PENDIENTE, ACEPTADA, RECHAZADA]
          required: false
          description: Filtra las actividades por el visto bueno del organizador.
      responses:
        '200':
          description: Lista de actividades con información detallada e inscripciones.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActividadConInscripciones'
        '404':
          description: Organización no encontrada.

  /actividades:
    get:
      tags:
        - Actividades
      summary: Listar todas las actividades
      description: Devuelve la lista de actividades disponibles.
      responses:
        '200':
          description: Lista recuperada con éxito
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActividadDetalle'

  /actividades/crear:
    post:
      tags:
        - Actividades
      summary: Publicar una nueva actividad
      description: Una organización crea una actividad.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActividadCreacion'
      responses:
        '201':
          description: Actividad creada exitosamente

  /actividades/{codActividad}/inscribir:
    post:
      tags:
        - Actividades
      summary: Inscribir voluntario en actividad
      description: Apunta a un voluntario a una actividad específica.
      parameters:
        - name: codActividad
          in: path
          required: true
          description: ID único de la actividad
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InscripcionRequest'
      responses:
        '201':
          description: Inscripción creada.
        '404':
          description: Actividad o Voluntario no encontrado.
        '409':
          description: Ya inscrito.

  /actividades/{id}/estado:
    patch:
      summary: Actualiza el estado de ejecución de una actividad.
      tags:
        - Actividades
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          required: true
          description: ID de la actividad
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [estado]
              properties:
                estado:
                  type: string
                  enum: [PENDIENTE, EN CURSO, FINALIZADO, CANCELADO]
                  description: Nuevo estado de la actividad (case-insensitive).
      responses:
        '200':
          description: Estado actualizado.
        '400':
          description: Estado inválido o faltante.
        '404':
          description: Actividad no encontrada.

  # ==========================================
  # INSCRIPCIONES
  # ==========================================
  /inscripciones:
    get:
      tags:
        - Inscripciones
      summary: Listar todas las inscripciones pendientes
      description: Devuelve una lista de todas las inscripciones con estado PENDIENTE en el sistema.
      responses:
        '200':
          description: Lista de pendientes recuperada con éxito
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InscripcionDetalle'
    post:
      tags:
        - Inscripciones
      summary: Crear una nueva inscripción
      description: Permite a un voluntario inscribirse en una actividad especificando ambos IDs.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InscripcionNueva'
      responses:
        '201':
          description: Inscripción creada correctamente
          content:
            application/json:
              example:
                message: "Inscripción creada correctamente"
        '400':
          description: Faltan datos o son inválidos
        '404':
          description: Voluntario o Actividad no encontrados
        '409':
          description: El voluntario ya está inscrito

  /inscripciones/{id}/estado:
    patch:
      tags:
        - Inscripciones
      summary: Actualizar estado de inscripción
      description: Cambia el estado de una inscripción (ej. Confirmar, Rechazar).
      parameters:
        - name: id
          in: path
          required: true
          description: ID numérico de la inscripción
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEstadoRequest'
      responses:
        '200':
          description: Estado actualizado correctamente
          content:
            application/json:
              example:
                message: "Estado actualizado correctamente"
                nuevo_estado: "CONFIRMADO"
        '400':
          description: Estado inválido o falta campo
        '404':
          description: Inscripción no encontrada

  /inscripciones/voluntario/{dni}/pendientes:
    get:
      tags:
        - Inscripciones
      summary: Listar inscripciones pendientes de un voluntario
      description: Devuelve todas las inscripciones con estado PENDIENTE para un DNI dado.
      parameters:
        - name: dni
          in: path
          required: true
          description: DNI del voluntario
          schema:
            type: string
      responses:
        '200':
          description: Lista de inscripciones pendientes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InscripcionPendiente'
        '404':
          description: Voluntario no encontrado



  /inscripciones/voluntario/{dni}/actividades-aceptadas:
    get:
      tags:
        - Inscripciones
      summary: Listar actividades ACEPTADAS de un voluntario (filtro opcional por estado)
      description: Recupera actividades donde el voluntario está CONFIRMADO, permitiendo filtrar por el estado de la actividad (PENDIENTE, EN CURSO, FINALIZADO).
      parameters:
        - name: dni
          in: path
          required: true
          description: DNI del voluntario
          schema:
            type: string
        - name: estado
          in: query
          required: false
          description: Estado de la actividad para filtrar (ej. PENDIENTE, EN CURSO)
          schema:
            type: string
            enum: ["PENDIENTE", "EN_CURSO", "FINALIZADO"]
            example: "PENDIENTE"
      responses:
        '200':
          description: Lista de actividades filtradas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActividadInscritaDetalle'
        '404':
          description: Voluntario no encontrado

  /inscripciones/organizacion/{cif}:
    get:
      tags:
        - Inscripciones
      summary: Listar inscripciones de actividades de una organización
      description: Devuelve todas las inscripciones (solicitudes de voluntarios) para las actividades creadas por la organización especificada.
      parameters:
        - name: cif
          in: path
          required: true
          description: CIF de la organización
          schema:
            type: string
        - name: estado
          in: query
          required: false
          description: Filtrar por estado de la inscripción
          schema:
            type: string
            enum: ["PENDIENTE", "CONFIRMADO", "RECHAZADO", "EN_CURSO", "FINALIZADO"]
            example: "PENDIENTE"
      responses:
        '200':
          description: Lista de inscripciones recuperada con éxito
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InscripcionOrganizacionDetalle'
        '404':
          description: Organización no encontrada

  /voluntarios:
    get:
      tags:
        - Voluntarios
      summary: Listar todos los voluntarios
      description: Devuelve la lista completa de voluntarios registrados.
      responses:
        '200':
          description: Lista recuperada con éxito
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VoluntarioDetalle'

  /voluntarios/{dni}/estado:
    patch:
      tags:
        - Voluntarios
      summary: Actualizar estado global del voluntario (PLATAFORMA)
      description: Cambia el estado del voluntario en la plataforma (PENDIENTE, ACEPTADO, RECHAZADO).
      parameters:
        - name: dni
          in: path
          required: true
          description: DNI del voluntario
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEstadoRequest'
      responses:
        '200':
          description: Estado actualizado correctamente
          content:
            application/json:
              example:
                message: "Estado del voluntario actualizado correctamente"
                nuevo_estado: "ACEPTADO"
        '400':
          description: Estado inválido
        '404':
          description: Voluntario no encontrado

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- MODELOS DE AUTENTICACIÓN ---
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: "usuario@email.com"
        password:
          type: string
          format: password
          example: "1234"

    LoginResponse:
      type: object
      properties:
        token:
          type: string
        rol:
          type: string
          example: "ROLE_VOLUNTARIO"
        id:
          type: string
          description: "DNI o CIF del usuario logueado"
          example: "12345678Z"

    # --- MODELO REGISTRO VOLUNTARIO ---
    VoluntarioRegistro:
      type: object
      required: [nombreCompleto, dni, correo, password]
      properties:
        nombreCompleto:
          type: string
          example: "Juan Pérez García"
        dni:
          type: string
          example: "12345678Z"
        correo:
          type: string
          format: email
          example: "juan@gmail.com"
        password:
          type: string
          format: password
        zona:
          type: string
          example: "Pamplona"
        ciclo:
          type: string
          example: "DAW"
        fechaNacimiento:
          type: string
          format: date
          example: "1998-05-20"
        experiencia:
          type: string
          example: "Voluntariado previo en Cruz Roja"
        coche:
          type: string
          description: "Puede ser 'Si', 'No', 'true', etc."
          example: "Si"
        idiomas:
          type: array
          items:
            type: string
          example: ["Inglés", "Euskera"]
        habilidades:
          type: array
          items:
            type: string
          example: ["Primeros Auxilios", "Conducción"]
        intereses:
          type: array
          items:
            type: string
          example: ["Medio Ambiente", "Social"]
        disponibilidad:
          type: array
          items:
            type: string
          example: ["Lunes Mañana", "Fines de Semana"]

    # --- MODELO DETALLE VOLUNTARIO ---
    VoluntarioDetalle:
      type: object
      properties:
        dni:
          type: string
        nombre:
          type: string
        apellido1:
          type: string
        apellido2:
          type: string
        correo:
          type: string
        zona:
          type: string
        fechaNacimiento:
          type: string
          format: date
        experiencia:
          type: string
        coche:
          type: boolean
        habilidades:
          type: string
        intereses:
          type: string
        idiomas:
          type: string
        estadoVoluntario:
          type: string
          description: "Estado del voluntario en la plataforma (PENDIENTE, ACEPTADO, etc.)"
          example: "PENDIENTE"

    # --- MODELO REGISTRO ORGANIZACIÓN ---
    OrganizacionRegistro:
      type: object
      required: [cif, nombre, email, password]
      properties:
        cif:
          type: string
          example: "G99887766"
        nombre:
          type: string
          example: "Asociación Ayuda Mutua"
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        sector:
          type: string
          example: "Salud"
        zona:
          type: string
          example: "Burlada"
        descripcion:
          type: string
          example: "ONG dedicada a..."

    OrganizacionDetalle:
      type: object
      properties:
        cif:
          type: string
        nombre:
          type: string
        estado:
          type: string
          description: "Estado de la organización (pendiente, aprobado, rechazado)"
          example: "pendiente"
        email:
          type: string
          format: email
        sector:
          type: string
        direccion:
          type: string
        localidad:
          type: string
        cp:
          type: string
        descripcion:
          type: string
        contacto:
          type: string
        actividades:
          type: array
          items:
            $ref: '#/components/schemas/ActividadDetalle'

    # --- MODELOS DE ACTIVIDADES ---
    ActividadCreacion:
      type: object
      required: [cifOrganizacion, nombre]
      properties:
        cifOrganizacion:
          type: string
          description: "CIF de la organización dueña"
          example: "G99887766"
        nombre:
          type: string
          example: "Recogida de Alimentos"
        descripcion:
          type: string
        fechaInicio:
          type: string
          format: date
          example: "2025-12-01"
        fechaFin:
          type: string
          format: date
          example: "2025-12-31"
        maxParticipantes:
          type: integer
          example: 20
        ods:
          type: array
          items:
            type: string
          example: ["Hambre Cero", "Salud"]

    ActividadDetalle:
      type: object
      properties:
        codActividad:
          type: integer
        nombre:
          type: string
        organizacion:
          type: object
          properties:
            nombre:
              type: string
            cif:
              type: string
        descripcion:
          type: string
        fechaInicio:
          type: string
          format: date

    # --- MODELO INSCRIPCIÓN ---
    InscripcionRequest:
      type: object
      required: [dni_voluntario]
      properties:
        dni_voluntario:
          type: string
          example: "12345678Z"

    InscripcionNueva:
      type: object
      required: [dniVoluntario, codActividad]
      properties:
        dniVoluntario:
          type: string
          example: "12345678Z"
        codActividad:
          type: integer
          example: 1


    InscripcionPendiente:
      type: object
      properties:
        id_inscripcion:
          type: integer
        codActividad:
          type: integer
        nombre_actividad:
          type: string
        fecha_actividad:
          type: string
          format: date-time
        nombre_organizacion:
          type: string
        estado:
          type: string
          example: "PENDIENTE"

    ActividadInscritaDetalle:
      type: object
      properties:
        codActividad:
          type: integer
        nombre:
          type: string
        direccion:
          type: string
        fechaInicio:
          type: string
          format: date-time
        fechaFin:
          type: string
          format: date-time
        organizacion:
          type: string
        id_inscripcion:
          type: integer

    # --- MODELO ACTUALIZAR ESTADO ---
    UpdateEstadoRequest:
      type: object
      required: [estado]
      properties:
        estado:
          type: string
          description: "Nuevo estado (PENDIENTE, CONFIRMADO, RECHAZADO, EN_CURSO, FINALIZADO)"
          example: "CONFIRMADO"

    InscripcionDetalle:
      type: object
      properties:
        id_inscripcion:
          type: integer
        dni_voluntario:
          type: string
        nombre_voluntario:
          type: string
        codActividad:
          type: integer
        nombre_actividad:
          type: string
        estado:
          type: string
          example: "PENDIENTE"
        estadoAprobacion:
          type: string
          example: "PENDIENTE"

    InscripcionOrganizacionDetalle:
      type: object
      properties:
        id_inscripcion:
          type: integer
        estado:
          type: string
          example: "PENDIENTE"
        voluntario:
          type: object
          properties:
            dni:
              type: string
            telefono:
              type: string
              nullable: true
        actividad:
          type: object
          properties:
            codActividad:
              type: integer
            nombre:
              type: string


    ActividadConInscripciones:
      type: object
      properties:
        codActividad:
          type: integer
        nombre:
          type: string
        estado:
          type: string
        estadoAprobacion:
          type: string
          example: "PENDIENTE"
        direccion:
          type: string
        fechaInicio:
          type: string
          format: date-time
        maxParticipantes:
          type: integer
        inscripciones:
          type: array
          items:
            $ref: '#/components/schemas/InscripcionOrganizacionDetalle'
