<!-- Backdrop -->
<div class="custom-backdrop" (click)="close.emit()"></div>

<!-- Modal -->
<div class="modal fade show d-block" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-custom-blue">Crear Nuevo Match</h5>
                <button type="button" class="btn-close" (click)="close.emit()"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-4">
                    <label class="form-label fw-bold text-muted">Voluntario</label>
                    @if (selectedActivityId) {
                    <div class="form-text mb-2 text-custom-blue">
                        <i class="bi bi-magic me-1"></i> Ordenados por afinidad con la actividad
                    </div>
                    }
                    <select class="form-select bg-light border-0 py-3" [(ngModel)]="selectedVolunteerDnI"
                        [disabled]="!!preselectedVolunteer">
                        <option value="" disabled selected>Selecciona un voluntario</option>
                        @for (vol of volunteers; track vol.dni) {
                        <option [value]="vol.dni" [style.fontWeight]="vol.matchScore > 50 ? 'bold' : 'normal'"
                            [class.text-success]="vol.matchScore > 70">
                            {{ vol.matchScore !== undefined ? '-' + vol.matchScore + '% | ' : '' }} {{ vol.nombre }} {{
                            vol.apellido1 }} - {{ vol.email }}
                        </option>
                        }
                    </select>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-muted">Actividad</label>
                    <select class="form-select bg-light border-0 py-3" [(ngModel)]="selectedActivityId"
                        [disabled]="!!preselectedActivityId" (change)="onActivityChange()">
                        <option [ngValue]="null" disabled selected>Selecciona una actividad</option>
                        @for (act of activities; track act.codActividad || act.id) {
                        <option [value]="act.codActividad || act.id">
                            {{ act.nombre }}
                        </option>
                        }
                    </select>
                </div>

                <!-- Smart Matching Info -->
                @if (selectedVolunteer || selectedActivity) {
                <div class="row g-3 p-3 bg-light rounded-4 mb-3">
                    @if (selectedVolunteer) {
                    <div class="col-6">
                        <h6 class="fw-bold text-custom-blue mb-2">
                            <i class="bi bi-person me-1"></i> {{ selectedVolunteer.nombre }} {{
                            selectedVolunteer.apellido1 }}
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            <span *ngFor="let skill of selectedVolunteer.habilidades"
                                class="badge bg-white text-dark border px-2 py-1 fw-normal">
                                {{ skill.nombre || skill }}
                            </span>
                            <small *ngIf="!selectedVolunteer.habilidades?.length" class="text-muted fst-italic">Sin
                                habilidades</small>
                        </div>
                    </div>
                    }

                    @if (selectedActivity) {
                    <div class="col-6">
                        <h6 class="fw-bold text-custom-blue mb-2">
                            <i class="bi bi-activity me-1"></i> Requisitos
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            <span *ngFor="let need of selectedActivity.habilidades"
                                class="badge bg-custom-blue text-white border-0 px-2 py-1 fw-normal">
                                {{ need.nombre || need }}
                            </span>
                            <small *ngIf="!selectedActivity.habilidades?.length" class="text-muted fst-italic">Sin
                                requisitos</small>
                        </div>
                    </div>
                    }
                </div>
                }
            </div>
            <div class="modal-footer border-top-0 pt-0 px-4 pb-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" (click)="close.emit()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-custom-blue text-white rounded-pill px-4" (click)="onSubmit()"
                    [disabled]="isLoading || !selectedVolunteerDnI || !selectedActivityId">
                    {{ isLoading ? 'Creando...' : 'Crear Match' }}
                </button>
            </div>
        </div>
    </div>
</div>