<div class="d-flex flex-column min-vh-100 bg-light">
    <app-navbar></app-navbar>
    <div class="d-flex flex-grow-1 overflow-hidden">
        <app-sidebar></app-sidebar>
        <div class="flex-grow-1 d-flex flex-column overflow-hidden">
            <div class="container-fluid p-4 pb-0 flex-shrink-0">
                <!-- Header Section -->
                <div class="d-flex flex-column align-items-center mb-5">
                    <h2 class="text-custom-blue fw-bold mb-4">Voluntariados</h2>
                    <app-status-toggle leftLabel="Pendientes" rightLabel="Aceptados"
                        [leftCount]="pendingOpportunities.length" [rightCount]="acceptedOpportunities.length"
                        (optionChanged)="onTabChange($event)">
                    </app-status-toggle>

                    <!-- Search Bar (Centered below tabs) -->
                    <!-- Search Bar Removed -->
                </div>

                <!-- Subheader & Search -->
                <div class="card border-0 shadow-sm rounded-4 p-3 mb-4">
                    <div class="d-flex align-items-center flex-wrap gap-3">
                        <div class="d-flex align-items-center text-custom-blue">
                            <i class="bi bi-people me-2 fs-4"></i>
                            <h4 class="fw-bold mb-0">Voluntariados {{ activeTab === 'left' ? 'Pendientes' : 'Aceptados'
                                }}</h4>
                        </div>

                        <!-- Search Bar (Right Aligned) -->
                        <div class="d-flex align-items-center gap-3 ms-auto">
                            <div class="input-group bg-light rounded-pill px-3 py-2 shadow-sm border-0"
                                style="max-width: 350px; width: 100%;">
                                <span
                                    class="input-group-text bg-transparent border-0 text-custom-blue position-relative"
                                    style="cursor: pointer;" (click)="openFilterModal()">
                                    <i class="bi bi-sliders"></i>
                                    <span class="position-absolute constant-badge badge rounded-pill bg-danger"
                                        style="top: 5px; right: 5px; font-size: 0.5rem; padding: 0.25em 0.4em;"
                                        *ngIf="activeFilterCount > 0">
                                        {{ activeFilterCount }}
                                    </span>
                                </span>
                                <input type="text"
                                    class="form-control bg-transparent border-0 shadow-none ps-2 text-dark"
                                    placeholder="Buscar voluntariado..." [(ngModel)]="searchTerm"
                                    (input)="applyFilters()">
                                <span class="input-group-text bg-transparent border-0 text-muted"><i
                                        class="bi bi-search"></i></span>
                            </div>


                            <button
                                class="btn btn-custom-blue text-white rounded-pill px-4 py-2 d-flex align-items-center text-nowrap"
                                (click)="openCreateModal()">
                                <i class="bi bi-plus-lg me-2"></i> Nuevo Voluntariado
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-grow-1 overflow-auto">
                <div class="container-fluid px-4 pb-4">
                    <div class="row g-4">
                        <div class="col-md-6" *ngFor="let item of filteredOpportunities">
                            <app-volunteering-card [title]="item.title" [organization]="item.organization"
                                [skills]="item.skills" [date]="item.date" [ods]="item.ods" [status]="item.estado"
                                (onAction)="onAction(item)" (onInfo)="openInfoModal(item)"
                                (onAssign)="openAssignModal(item)">
                            </app-volunteering-card>
                        </div>
                        <div *ngIf="filteredOpportunities.length === 0" class="col-12 text-center py-5">
                            <p class="text-muted">No se encontraron voluntariados con los filtros seleccionados.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Info Modal -->
<div class="modal fade show d-block modal-backdrop-custom" tabindex="-1" *ngIf="showInfoModal && selectedVolunteering">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold text-custom-blue">Detalles del Voluntariado</h5>
                <button type="button" class="btn-close" (click)="closeInfoModal()"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="rounded-circle bg-custom-blue text-white d-inline-flex align-items-center justify-content-center mb-3"
                        style="width: 80px; height: 80px;">
                        <i class="bi bi-building fs-1"></i>
                    </div>
                    <h4 class="fw-bold text-custom-blue mb-1">{{ selectedVolunteering.title }}</h4>
                    <p class="text-muted mb-0">{{ selectedVolunteering.organization }}</p>
                </div>

                <div class="row g-3">
                    <div class="col-12">
                        <div class="p-3 bg-light rounded-3">
                            <small class="text-uppercase text-muted fw-bold"
                                style="font-size: 0.7rem;">Descripción</small>
                            <p class="mb-0 fw-medium">Descripción detallada de la actividad voluntaria. Aquí se
                                explicarían las tareas
                                específicas, el impacto esperado y los requisitos adicionales.</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded-3 h-100">
                            <small class="text-uppercase text-muted fw-bold"
                                style="font-size: 0.7rem;">Ubicación</small>
                            <p class="mb-0 fw-medium">Madrid, Centro</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded-3 h-100">
                            <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Fecha</small>
                            <p class="mb-0 fw-medium">{{ selectedVolunteering.date }}</p>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="p-3 bg-light rounded-3">
                            <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">ODS
                                Relacionados</small>
                            <div class="mt-2 d-flex gap-2 flex-wrap">
                                <span *ngFor="let item of selectedVolunteering.ods"
                                    class="badge text-white px-3 py-2 rounded-pill"
                                    [style.backgroundColor]="item.color">
                                    {{ item.nombre }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Removed redundant Cerrar button -->
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade show d-block modal-backdrop-custom" tabindex="-1" *ngIf="showFilterModal">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h3 class="modal-title fw-bold text-custom-blue">Filtrar Voluntariados</h3>
                <button type="button" class="btn-close" (click)="closeFilterModal()"></button>
            </div>
            <div class="modal-body p-4">

                <div class="row g-4">
                    <!-- Date Filter -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-dark mb-2">Fecha</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-calendar"></i></span>
                            <input type="date" class="form-control bg-light border-0" [(ngModel)]="tempFilters.date">
                        </div>
                    </div>

                    <!-- Organization Filter -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-dark mb-2">Organización</label>
                        <select class="form-select border-light-gray" [(ngModel)]="tempFilters.organization">
                            <option value="">Todas las organizaciones</option>
                            <option *ngFor="let org of availableOrganizations" [value]="org">{{ org }}</option>
                        </select>
                    </div>

                    <!-- Skills Filter -->
                    <div class="col-12">
                        <label class="form-label fw-bold text-dark mb-2">Habilidades</label>
                        <div class="d-flex flex-wrap gap-2">
                            <span *ngFor="let item of availableSkills"
                                class="badge border px-3 py-2 rounded-pill fw-normal d-flex align-items-center gap-2 cursor-pointer"
                                [ngClass]="{'bg-custom-blue text-white': isSkillSelected(item.nombre), 'bg-white text-dark': !isSkillSelected(item.nombre)}"
                                style="cursor: pointer;" (click)="toggleSkillFilter(item.nombre)">
                                {{ item.nombre }}
                                <i class="bi"
                                    [ngClass]="{'bi-check-lg': isSkillSelected(item.nombre), 'bi-plus-lg': !isSkillSelected(item.nombre)}"></i>
                            </span>
                        </div>
                    </div>

                    <!-- ODS Filter -->
                    <div class="col-12">
                        <label class="form-label fw-bold text-dark mb-2">ODS Relacionados</label>
                        <div class="d-flex flex-wrap gap-2">
                            <span *ngFor="let ods of availableODS"
                                class="badge border px-3 py-2 rounded-pill fw-normal d-flex align-items-center gap-2 cursor-pointer"
                                [ngClass]="{'bg-success text-white': isOdsSelected(ods), 'bg-white text-dark': !isOdsSelected(ods)}"
                                style="cursor: pointer;" (click)="toggleOdsFilter(ods)">
                                {{ ods }}
                                <i class="bi"
                                    [ngClass]="{'bi-check-lg': isOdsSelected(ods), 'bi-plus-lg': !isOdsSelected(ods)}"></i>
                            </span>
                        </div>
                    </div>

                </div>

            </div>
            <div class="modal-footer border-0 justify-content-between px-4 pb-4">
                <button type="button" class="btn btn-outline-danger rounded-pill px-4" (click)="resetFilters()">
                    <i class="bi bi-trash me-1"></i> Limpiar
                </button>
                <button type="button" class="btn btn-custom-blue text-white rounded-pill px-4" (click)="applyFilters()">
                    Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Actividad -->
<app-crear-voluntariado-modal *ngIf="modalCrearActividadOpen" (close)="modalCrearActividadOpen = false"
    (created)="onVoluntariadoCreated($event)">
</app-crear-voluntariado-modal>

<!-- Modal Asignar Voluntario -->
<app-create-match-modal *ngIf="showAssignModal" [preselectedActivityId]="assignActivityId"
    (close)="showAssignModal = false" (matchCreated)="onMatchCreated()">
</app-create-match-modal>